<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ•°æ®åº“äº¤äº’å·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .app-container {
      width: 100%;
      max-width: 1400px;
      height: 90vh;
      background: rgba(255, 255, 255, 0.98);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    /* é¡¶éƒ¨å·¥å…·æ  - Tå‹å¸ƒå±€çš„æ¨ªå‘éƒ¨åˆ† */
    .toolbar {
      background: linear-gradient(180deg, #f5f5f7 0%, #e8e8ea 100%);
      border-bottom: 1px solid #d1d1d6;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .toolbar-section {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 12px;
      border-right: 1px solid #d1d1d6;
    }

    .toolbar-section:last-child {
      border-right: none;
    }

    .toolbar-section label {
      font-size: 13px;
      font-weight: 500;
      color: #1d1d1f;
    }

    .toolbar-section input,
    .toolbar-section select {
      padding: 6px 12px;
      border: 1px solid #d1d1d6;
      border-radius: 8px;
      font-size: 13px;
      background: white;
      transition: all 0.2s;
      min-width: 150px;
    }

    .toolbar-section input:focus,
    .toolbar-section select:focus {
      outline: none;
      border-color: #0071e3;
      box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1);
    }

    .file-upload-btn {
      position: relative;
      padding: 8px 20px;
      background: linear-gradient(180deg, #0071e3 0%, #0077ed 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0, 113, 227, 0.3);
    }

    .file-upload-btn:hover {
      background: linear-gradient(180deg, #0077ed 0%, #006edb 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 113, 227, 0.4);
    }

    .file-upload-btn:active {
      transform: translateY(0);
    }

    #file-input {
      display: none;
    }

    .upload-button {
      padding: 8px 24px;
      background: linear-gradient(180deg, #34c759 0%, #30b350 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3);
    }

    .upload-button:hover {
      background: linear-gradient(180deg, #30b350 0%, #2ca548 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(52, 199, 89, 0.4);
    }

    .download-button {
      padding: 8px 24px;
      background: linear-gradient(180deg, #ff9500 0%, #ff8c00 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(255, 149, 0, 0.3);
    }

    .download-button:hover {
      background: linear-gradient(180deg, #ff8c00 0%, #ff7a00 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 149, 0, 0.4);
    }

    .download-button:active,
    .upload-button:active {
      transform: translateY(0);
    }

    /* ä¸»å†…å®¹åŒºåŸŸ - Tå‹å¸ƒå±€çš„çºµå‘éƒ¨åˆ† */
    .main-container {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* å·¦ä¾§é…ç½®é¢æ¿ */
    .config-panel {
      width: 320px;
      background: #fafafa;
      border-right: 1px solid #e5e5e7;
      padding: 20px;
      overflow-y: auto;
    }

    .config-section {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .config-section h3 {
      font-size: 14px;
      font-weight: 600;
      color: #1d1d1f;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .config-section h3::before {
      content: "";
      width: 4px;
      height: 16px;
      background: linear-gradient(180deg, #0071e3 0%, #0077ed 100%);
      border-radius: 2px;
    }

    .input-group {
      margin-bottom: 12px;
    }

    .input-group:last-child {
      margin-bottom: 0;
    }

    .input-group label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: #6e6e73;
      margin-bottom: 6px;
    }

    .input-group input,
    .input-group select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d1d6;
      border-radius: 8px;
      font-size: 13px;
      background: white;
      transition: all 0.2s;
    }

    .input-group input:focus,
    .input-group select:focus {
      outline: none;
      border-color: #0071e3;
      box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1);
    }

    /* å³ä¾§èŠå¤©åŒºåŸŸ */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
    }

    .chat-messages {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      scroll-behavior: smooth;
    }

    .message {
      margin-bottom: 16px;
      display: flex;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      justify-content: flex-end;
    }

    .message-content {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .message.bot .message-content {
      background: #f5f5f7;
      color: #1d1d1f;
      border-bottom-left-radius: 4px;
    }

    .message.user .message-content {
      background: linear-gradient(135deg, #0071e3 0%, #0077ed 100%);
      color: white;
      border-bottom-right-radius: 4px;
    }

    /* è¾“å…¥åŒºåŸŸ */
    .chat-input-area {
      padding: 16px 24px;
      background: #fafafa;
      border-top: 1px solid #e5e5e7;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .chat-input-area input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #d1d1d6;
      border-radius: 20px;
      font-size: 14px;
      background: white;
      transition: all 0.2s;
    }

    .chat-input-area input:focus {
      outline: none;
      border-color: #0071e3;
      box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1);
    }

    .send-button {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, #0071e3 0%, #0077ed 100%);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0, 113, 227, 0.3);
    }

    .send-button:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 113, 227, 0.4);
    }

    .send-button:active {
      transform: scale(0.95);
    }

    .send-button::after {
      content: "â¤";
      color: white;
      font-size: 18px;
    }

    /* çŠ¶æ€æç¤º */
    .status-badge {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 8px 16px;
      background: rgba(52, 199, 89, 0.95);
      color: white;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      display: none;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* æ»šåŠ¨æ¡æ ·å¼ */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #d1d1d6;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #b1b1b6;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 1024px) {
      .config-panel {
        width: 280px;
      }

      .toolbar {
        padding: 12px 16px;
      }

      .toolbar-section {
        flex-basis: 100%;
        border-right: none;
        border-bottom: 1px solid #d1d1d6;
        padding: 8px 0;
      }

      .toolbar-section:last-child {
        border-bottom: none;
      }
    }

    @media (max-width: 768px) {
      .app-container {
        height: 95vh;
        border-radius: 12px;
      }

      .main-container {
        flex-direction: column;
      }

      .config-panel {
        width: 100%;
        max-height: 40vh;
        border-right: none;
        border-bottom: 1px solid #e5e5e7;
      }

      .message-content {
        max-width: 85%;
      }
    }
  </style>
</head>

<body>
  <div class="app-container">
    <!-- é¡¶éƒ¨å·¥å…·æ  - Tå‹å¸ƒå±€æ¨ªå‘ -->
    <div class="toolbar">
      <div class="toolbar-section">
        <label>ğŸ“„ SQLæ–‡ä»¶:</label>
        <input type="file" id="file-input" accept=".sql">
        <label for="file-input" class="file-upload-btn">é€‰æ‹©æ–‡ä»¶</label>
      </div>
      <div class="toolbar-section">
        <label>æ•°æ®åº“ç±»å‹:</label>
        <select id="dialect">
          <option value="mysql" selected>MySQL</option>
          <option value="postgre">PostgreSQL</option>
          <option value="oracle">Oracle</option>
        </select>
      </div>
      <div style="margin-left: auto; display: flex; gap: 12px; align-items: center;">
        <button class="download-button" id="download-button" style="display: none;">â¬‡ï¸ ä¸‹è½½æ–‡ä»¶</button>
        <button class="upload-button" id="upload-button">ä¸Šä¼ å¹¶å¤„ç†</button>
      </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº - Tå‹å¸ƒå±€çºµå‘ -->
    <div class="main-container">
      <!-- å·¦ä¾§é…ç½®é¢æ¿ -->
      <div class="config-panel">
        <div class="config-section">
          <h3>æµ‹è¯•æ•°æ®åº“</h3>
          <div class="input-group">
            <label>æ•°æ®åº“åœ°å€</label>
            <input type="text" id="db_address" placeholder="localhost:3306/db_name">
          </div>
          <div class="input-group">
            <label>ç”¨æˆ·å</label>
            <input type="text" id="db_user" placeholder="è¯»å†™æƒé™ç”¨æˆ·">
          </div>
          <div class="input-group">
            <label>å¯†ç </label>
            <input type="password" id="db_pwd" placeholder="æ•°æ®åº“å¯†ç ">
          </div>
        </div>

        <div class="config-section">
          <h3>ç”Ÿäº§æ•°æ®åº“</h3>
          <div class="input-group">
            <label>æ•°æ®åº“åœ°å€</label>
            <input type="text" id="prod_db_address" placeholder="localhost:3306/db_name">
          </div>
          <div class="input-group">
            <label>ç”¨æˆ·å</label>
            <input type="text" id="prod_db_user" placeholder="åªè¯»ç”¨æˆ·">
          </div>
          <div class="input-group">
            <label>å¯†ç </label>
            <input type="password" id="prod_db_pwd" placeholder="æ•°æ®åº“å¯†ç ">
          </div>
        </div>
      </div>

      <!-- å³ä¾§èŠå¤©åŒºåŸŸ -->
      <div class="chat-container">
        <div class="chat-messages" id="chat-area">
          <div class="message bot">
            <div class="message-content">ğŸ‘‹ æ¬¢è¿ä½¿ç”¨æ•°æ®åº“äº¤äº’å·¥å…·ï¼è¯·ä¸Šä¼ SQLæ–‡ä»¶å¹¶é…ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯å¼€å§‹ä½¿ç”¨ã€‚</div>
          </div>
        </div>
        <div class="chat-input-area">
          <input type="text" id="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
          <button class="send-button" id="send-button"></button>
        </div>
      </div>
    </div>
  </div>

  <div class="status-badge" id="status-badge">å¤„ç†ä¸­...</div>

  <script>
    const fileInput = document.getElementById('file-input');
    const uploadButton = document.getElementById('upload-button');
    const downloadButton = document.getElementById('download-button');
    const chatArea = document.getElementById('chat-area');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const statusBadge = document.getElementById('status-badge');

    let downloadUrl = ''; // å­˜å‚¨ä¸‹è½½URL

    // æ˜¾ç¤ºçŠ¶æ€æç¤º
    function showStatus(message, duration = 3000) {
      statusBadge.textContent = message;
      statusBadge.style.display = 'block';
      setTimeout(() => {
        statusBadge.style.display = 'none';
      }, duration);
    }

    // æ–‡ä»¶é€‰æ‹©æç¤º
    fileInput.addEventListener('change', (e) => {
      const fileName = e.target.files[0]?.name;
      if (fileName) {
        showStatus(`å·²é€‰æ‹©: ${fileName}`);
      }
    });

    // ä¸‹è½½æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    downloadButton.addEventListener('click', async () => {
      if (!downloadUrl) {
        alert('æ²¡æœ‰å¯ä¸‹è½½çš„æ–‡ä»¶');
        return;
      }

      try {
        showStatus('æ­£åœ¨ä¸‹è½½...', 5000);

        // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„aæ ‡ç­¾æ¥è§¦å‘ä¸‹è½½
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = ''; // ä½¿ç”¨æœåŠ¡å™¨æä¾›çš„æ–‡ä»¶å
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        showStatus('âœ“ ä¸‹è½½å·²å¼€å§‹');
      } catch (error) {
        console.error('Download error:', error);
        showStatus('ä¸‹è½½å¤±è´¥', 3000);
      }
    });

    // æ–‡ä»¶ä¸Šä¼ é€»è¾‘
    uploadButton.addEventListener('click', async () => {
      const file = fileInput.files[0];
      if (!file) {
        alert('è¯·å…ˆé€‰æ‹©SQLæ–‡ä»¶');
        return;
      }

      // éšè—ä¸‹è½½æŒ‰é’®
      downloadButton.style.display = 'none';
      downloadUrl = '';

      showStatus('ä¸Šä¼ ä¸­...', 10000);
      chatArea.innerHTML = '';

      const formData = new FormData();
      formData.append('file', file);
      formData.append('dialect', document.getElementById('dialect').value);
      formData.append('db_addr', document.getElementById('db_address').value.trim());
      formData.append('db_user', document.getElementById('db_user').value.trim());
      formData.append('db_pwd', document.getElementById('db_pwd').value.trim());
      formData.append('prod_db_addr', document.getElementById('prod_db_address').value.trim());
      formData.append('prod_db_user', document.getElementById('prod_db_user').value.trim());
      formData.append('prod_db_pwd', document.getElementById('prod_db_pwd').value.trim());

      try {
        const response = await fetch('/api/upload', {
          method: 'POST',
          body: formData,
        });

        if (!response.ok) {
          const errorText = await response.text();
          addMessage('bot', `âŒ ä¸Šä¼ å¤±è´¥: ${errorText}`);
          showStatus('ä¸Šä¼ å¤±è´¥', 3000);
          return;
        }

        if (response.headers.get('Content-Type')?.includes('text/event-stream')) {
          showStatus('å¤„ç†ä¸­...', 10000);
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let change_set = '';
          let botMessageDiv = addMessage('bot', 'æ­£åœ¨å¤„ç†æ–‡æ¡£...');
          let buffer = "";

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });

            const events = buffer.split("\n\n");
            buffer = events.pop(); // åŠåŒ…
            for (const evt of events) {
              const lines = evt.split("\n");
              let eventType = "message";
              let data = "";

              for (const line of lines) {
                if (line.startsWith("event:")) {
                  eventType = line.slice(6).trim();
                }
                if (line.startsWith("data:")) {
                  data += line.slice(5).trim();
                }
              }

              if (eventType === "control") {
                const jsonData = JSON.parse(data);
                downloadUrl = jsonData.url;
                downloadButton.style.display = 'block';
                showStatus('âœ“ æ–‡ä»¶å·²å‡†å¤‡å¥½ä¸‹è½½');
                console.log("ä¸‹è½½åœ°å€:", jsonData.url);
              } else if (eventType === "done") {
                change_set += "AIç”ŸæˆChangeSetå®Œæ¯•ï¼Œä»…ä¾›å‚è€ƒ";
              }
              else {
                change_set += data + "\n";
                botMessageDiv.querySelector('.message-content').textContent = change_set;
                chatArea.scrollTop = chatArea.scrollHeight;
              }
            }
          }
          showStatus('âœ“ å¤„ç†å®Œæˆ');
        } else {
          const text = await response.text();
          addMessage('bot', text);
          showStatus('âœ“ ä¸Šä¼ å®Œæˆ');
        }

      } catch (error) {
        console.error('Upload error:', error);
        addMessage('bot', `âŒ ä¸Šä¼ å¤±è´¥: ${error.message}`);
        showStatus('ä¸Šä¼ å¤±è´¥', 3000);
      } finally {
        fileInput.value = '';
      }
    });

    // èŠå¤©é€»è¾‘
    sendButton.addEventListener('click', handleSendMessage);
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        handleSendMessage();
      }
    });

    async function handleSendMessage() {
      const prompt = chatInput.value.trim();
      if (!prompt) return;

      addMessage('user', prompt);
      chatInput.value = '';
      let botMessageDiv = addMessage('bot', 'æ€è€ƒä¸­...');

      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ prompt: prompt }),
        });

        if (!response.ok) {
          const errorText = await response.text();
          botMessageDiv.querySelector('.message-content').textContent = `âŒ é”™è¯¯: ${errorText}`;
          throw new Error(`Network response was not ok: ${response.statusText}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let change_set = "";
        let buffer = "";

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });

          const events = buffer.split("\n\n");
          buffer = events.pop(); // åŠåŒ…
          for (const evt of events) {
            const lines = evt.split("\n");
            let eventType = "message";
            let data = "";

            for (const line of lines) {
              if (line.startsWith("event:")) {
                eventType = line.slice(6).trim();
              }
              if (line.startsWith("data:")) {
                data += line.slice(5).trim();
              }
            }

            if (eventType === "done") {
              showStatus('âœ“ ChangeSetç”Ÿæˆå®Œæ¯•');
              change_set += "AIç”ŸæˆChangeSetå®Œæ¯•ï¼Œä»…ä¾›å‚è€ƒ";
            } else {
              change_set += data + "\n";
            }

            botMessageDiv.querySelector('.message-content').textContent = change_set;
            chatArea.scrollTop = chatArea.scrollHeight;
          }
        }
      } catch (error) {
        console.error('Chat error:', error);
        if (botMessageDiv) {
          botMessageDiv.querySelector('.message-content').textContent = `âŒ é”™è¯¯: ${error.message}`;
        }
      }
    }

    function addMessage(sender, text) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message', sender);
      const contentDiv = document.createElement('div');
      contentDiv.classList.add('message-content');
      contentDiv.textContent = text;
      messageDiv.appendChild(contentDiv);
      chatArea.appendChild(messageDiv);
      chatArea.scrollTop = chatArea.scrollHeight;
      return messageDiv;
    }
  </script>
</body>

</html>